<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»¿åŠ¨åœ°çƒ | æ™ºèƒ½ç¯ä¿ç”Ÿæ€åœˆ</title>
    <!-- å¼•å…¥è°·æ­Œå­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #059669; /* æ·±ç¿ ç»¿ */
            --primary-light: #34d399;
            --accent: #f59e0b; /* ç¥ç€é»„ */
            --text-dark: #111827;
            --text-light: #6b7280;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
            --bg-gradient: linear-gradient(120deg, #d4fc79 0%, #96e6a1 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', 'Noto Sans SC', sans-serif; }

        body {
            background-image: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
            min-height: 100vh; color: var(--text-dark); overflow-x: hidden; padding-bottom: 90px;
        }

        /* --- åŠ¨æ€èƒŒæ™¯çƒ --- */
        .bg-blob {
            position: fixed; width: 600px; height: 600px; background: #a7f3d0;
            filter: blur(80px); opacity: 0.4; z-index: -1; border-radius: 50%;
            animation: moveBlob 20s infinite alternate;
        }
        @keyframes moveBlob { from { transform: translate(-20%, -20%); } to { transform: translate(20%, 20%); } }

        /* --- å¯¼èˆªæ  --- */
        nav {
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px);
            position: sticky; top: 0; z-index: 100; padding: 1rem 5%;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        }
        .logo { font-size: 1.5rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; }

        .nav-links { display: flex; gap: 30px; }
        .nav-item {
            cursor: pointer; color: var(--text-light); font-weight: 600; transition: 0.3s; padding: 8px 12px; border-radius: 12px;
        }
        .nav-item:hover, .nav-item.active { color: var(--primary); background: rgba(5, 150, 105, 0.08); }

        /* --- ä¸»å®¹å™¨ --- */
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        .page-section { display: none; animation: slideUp 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
        .page-section.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        /* --- ç»ç’ƒæ‹Ÿæ€å¡ç‰‡ --- */
        .card {
            background: var(--glass-bg); backdrop-filter: blur(16px);
            border: var(--glass-border); border-radius: 24px;
            padding: 30px; box-shadow: var(--shadow); margin-bottom: 25px;
            transition: transform 0.3s ease;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.1); }

        /* --- æŒ‰é’® --- */
        .btn { padding: 12px 28px; border-radius: 50px; border: none; cursor: pointer; font-weight: 600; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, var(--primary-light), var(--primary)); color: white; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
        .btn-primary:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6); }
        .btn-outline { border: 2px solid var(--primary); color: var(--primary); background: transparent; }
        .btn-outline:hover { background: var(--primary); color: white; }

        /* --- é¦–é¡µç‰¹å®šæ ·å¼ --- */
        .hero-stats { display: flex; gap: 20px; margin-top: 20px; }
        .stat-box { flex: 1; text-align: center; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .stat-num { font-size: 1.8rem; font-weight: 800; color: var(--primary); }

        .upload-zone {
            border: 3px dashed #cbd5e1; border-radius: 24px; padding: 60px 20px;
            text-align: center; cursor: pointer; transition: 0.3s; background: rgba(255,255,255,0.5);
        }
        .upload-zone:hover { border-color: var(--primary); background: rgba(16,185,129,0.05); transform: scale(1.01); }

        /* --- æ’è¡Œæ¦œ --- */
        .leaderboard-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
        .rank-badge { width: 24px; height: 24px; background: #eee; border-radius: 50%; text-align: center; line-height: 24px; font-size: 0.8rem; font-weight: bold; }
        .rank-1 { background: #ffd700; color: white; }
        .rank-2 { background: #c0c0c0; color: white; }
        .rank-3 { background: #cd7f32; color: white; }

        /* --- ç¢³è¶³è¿¹ä»ªè¡¨ --- */
        .carbon-visual { position: relative; width: 200px; height: 200px; margin: 0 auto; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: conic-gradient(var(--primary) 0%, #e5e7eb 0%); transition: background 0.5s; }
        .carbon-inner { width: 160px; height: 160px; background: white; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        /* --- æ´»åŠ¨å¡ç‰‡ --- */
        .grid-layout { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .act-card { padding: 0; overflow: hidden; display: flex; flex-direction: column; height: 100%; }
        .act-img { height: 180px; object-fit: cover; width: 100%; }
        .act-body { padding: 20px; flex: 1; display: flex; flex-direction: column; }
        .act-meta { font-size: 0.85rem; color: #999; margin-bottom: 10px; display: flex; justify-content: space-between; }

        /* --- æ¨¡æ€æ¡† --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 400px; padding: 40px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: popIn 0.3s; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .form-input { width: 100%; padding: 14px; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 15px; outline: none; background: #f9fafb; }
        .form-input:focus { border-color: var(--primary); background: white; }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media(max-width: 768px) {
            .nav-links { position: fixed; bottom: 0; left: 0; width: 100%; background: white; justify-content: space-around; padding: 15px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); }
            .auth-area { display: none; }
            .hero-stats { flex-direction: column; }
        }
    </style>
</head>
<body>

    <div class="bg-blob" style="top: -100px; left: -100px;"></div>
    <div class="bg-blob" style="bottom: -100px; right: -100px; background: #fcd34d;"></div>

    <nav>
        <div class="logo"><i class="fas fa-recycle"></i> ç»¿åŠ¨åœ°çƒ</div>
        <div class="nav-links">
            <div class="nav-item active" onclick="switchPage('home')">æ™ºèƒ½è¯†åˆ«</div>
            <div class="nav-item" onclick="switchPage('carbon')">ç¢³è¶³è¿¹</div>
            <div class="nav-item" onclick="switchPage('activity')">ç¯ä¿æ´»åŠ¨</div>
            <div class="nav-item" onclick="switchPage('store')">ç»¿è‰²å•†åŸ</div>
            <div class="nav-item" onclick="switchPage('profile')">æˆ‘çš„ä¸­å¿ƒ</div>
        </div>
        <div class="auth-area" id="desktop-auth">
            <button class="btn btn-outline" onclick="openAuth('login')">ç™»å½•</button>
            <button class="btn btn-primary" onclick="openAuth('register')" style="margin-left: 10px;">æ³¨å†Œ</button>
        </div>
    </nav>

    <div class="container">
        <!-- 1. é¦–é¡µï¼šAI è¯†åˆ« + æ’è¡Œæ¦œ -->
        <div id="home" class="page-section active">
            <div style="display: flex; gap: 40px; align-items: flex-start; flex-wrap: wrap;">
                <!-- å·¦ä¾§ï¼šAI è¯†åˆ«åŒº -->
                <div style="flex: 2; min-width: 300px;">
                    <div class="card" style="text-align: center; padding: 50px;">
                        <h1 style="font-size: 2.5rem; margin-bottom: 10px; background: linear-gradient(to right, var(--primary), var(--primary-light)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">AI æ™ºèƒ½åˆ†ç±»åŠ©æ‰‹</h1>
                        <p style="color: var(--text-light); margin-bottom: 30px;">ä¸Šä¼ åƒåœ¾å›¾ç‰‡ï¼ŒAI è‡ªåŠ¨è¯†åˆ«å¹¶è·å–ç»¿è‰²ç§¯åˆ†</p>

                        <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--primary); margin-bottom: 15px;"></i>
                            <p style="font-weight: 600;">ç‚¹å‡»ä¸Šä¼  / æ‹–æ‹½å›¾ç‰‡</p>
                            <input type="file" id="fileInput" hidden accept="image/*" onchange="handleFile(this)">
                        </div>

                        <!-- è¯†åˆ«ç»“æœå±•ç¤º -->
                        <div id="ai-result" style="display: none; margin-top: 30px; animation: slideUp 0.5s;">
                            <img id="preview-img" style="max-height: 200px; border-radius: 16px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                            <div style="margin-top: 20px;">
                                <span id="res-group" style="background: var(--accent); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold;">--</span>
                                <h2 id="res-name" style="margin: 10px 0; font-size: 2rem;">--</h2>
                                <p style="color: var(--primary); font-weight: bold; font-size: 1.2rem;">+<span id="res-points">0</span> ç§¯åˆ†</p>
                            </div>
                        </div>

                        <button id="scanBtn" class="btn btn-primary" style="margin-top: 20px; width: 100%; justify-content: center;" onclick="doIdentify()" disabled>å¼€å§‹è¯†åˆ«</button>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šæ’è¡Œæ¦œ -->
                <div style="flex: 1; min-width: 250px;">
                    <div class="card">
                        <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-trophy" style="color: gold;"></i> ç¯ä¿è¾¾äººæ¦œ
                        </h3>
                        <div id="leaderboard-list">
                            <p style="text-align: center; color: #999;">åŠ è½½ä¸­...</p>
                        </div>
                    </div>

                    <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <h3>ä»Šæ—¥ç¯ä¿è´´å£«</h3>
                        <p style="font-size: 0.9rem; margin-top: 10px; opacity: 0.9;">éšæ‰‹å…³ç¯ä¸€å°æ—¶ï¼Œå¯ä»¥å‡å°‘çº¦ 0.78kg çš„ç¢³æ’æ”¾ã€‚</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. ç¢³è¶³è¿¹ -->
        <div id="carbon" class="page-section">
            <div class="card">
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2>æ¯å‘¨ç¢³è¶³è¿¹è®¡ç®—å™¨</h2>
                    <p style="color: var(--text-light);">é‡åŒ–ä½ çš„ç”Ÿæ´»ï¼Œä¸ºåœ°çƒå‡è´Ÿ</p>
                </div>

                <div style="display: flex; flex-wrap: wrap; gap: 40px; align-items: center; justify-content: center;">
                    <div style="flex: 1; min-width: 300px;">
                        <div style="margin-bottom: 25px;">
                            <label style="display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 10px;">
                                <span>ğŸš— ç§å®¶è½¦å‡ºè¡Œ (km)</span> <span id="lbl-car" style="color: var(--primary);">0</span>
                            </label>
                            <input type="range" class="form-input" style="padding: 0;" min="0" max="500" value="0" id="in-car" oninput="calcCarbon()">
                        </div>
                        <div style="margin-bottom: 25px;">
                            <label style="display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 10px;">
                                <span>âš¡ å®¶åº­ç”¨ç”µ (åº¦)</span> <span id="lbl-elec" style="color: var(--primary);">0</span>
                            </label>
                            <input type="range" class="form-input" style="padding: 0;" min="0" max="100" value="0" id="in-elec" oninput="calcCarbon()">
                        </div>
                        <div style="margin-bottom: 25px;">
                            <label style="display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 10px;">
                                <span>ğŸ¥© è‚‰ç±»æ¶ˆè´¹ (kg)</span> <span id="lbl-meat" style="color: var(--primary);">0</span>
                            </label>
                            <input type="range" class="form-input" style="padding: 0;" min="0" max="20" value="0" id="in-meat" oninput="calcCarbon()">
                        </div>
                    </div>

                    <div style="text-align: center;">
                        <div class="carbon-visual" id="carbon-ring">
                            <div class="carbon-inner">
                                <h1 id="total-co2" style="font-size: 2.5rem; color: var(--text-dark);">0.0</h1>
                                <span style="color: var(--text-light);">kg COâ‚‚</span>
                            </div>
                        </div>
                        <button class="btn btn-outline" style="margin-top: 30px;" onclick="submitCarbon()">è®°å½•æ•°æ® (+5ç§¯åˆ†)</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. ç¯ä¿æ´»åŠ¨ -->
        <div id="activity" class="page-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2>çƒ­é—¨ç¯ä¿æ´»åŠ¨</h2>
                <button id="btn-create-act" class="btn btn-primary" style="display: none;" onclick="openActModal()">
                    <i class="fas fa-plus"></i> å‘å¸ƒæ´»åŠ¨
                </button>
            </div>

            <div class="grid-layout" id="act-grid">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- 4. ç»¿è‰²å•†åŸ -->
        <div id="store" class="page-section">
            <div class="card" style="background: linear-gradient(to right, #11998e, #38ef7d); color: white; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3>æˆ‘çš„å¯ç”¨ç§¯åˆ†</h3>
                    <h1 style="font-size: 3.5rem;" id="shop-points">0</h1>
                </div>
                <i class="fas fa-gift" style="font-size: 5rem; opacity: 0.3;"></i>
            </div>

            <h3 style="margin-bottom: 20px;">ç²¾é€‰å…‘æ¢</h3>
            <div class="grid-layout">
                <div class="card act-card">
                    <img src="https://images.unsplash.com/photo-1590623190838-89f41b250c05?auto=format&fit=crop&w=400" class="act-img">
                    <div class="act-body">
                        <h4>æœ‰æœºæ£‰ç¯ä¿è¢‹</h4>
                        <div style="margin-top: auto; padding-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--accent); font-weight: bold;">500 ç§¯åˆ†</span>
                            <button class="btn btn-sm btn-primary" onclick="redeem(500, 'ç¯ä¿è¢‹')">å…‘æ¢</button>
                        </div>
                    </div>
                </div>
                <div class="card act-card">
                    <img src="https://images.unsplash.com/photo-1542601906990-b4d3fb7d5fa5?auto=format&fit=crop&w=400" class="act-img">
                    <div class="act-body">
                        <h4>æ˜Ÿå·´å…‹å‡5å…ƒåˆ¸</h4>
                        <div style="margin-top: auto; padding-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--accent); font-weight: bold;">150 ç§¯åˆ†</span>
                            <button class="btn btn-sm btn-primary" onclick="redeem(150, 'ä¼˜æƒ åˆ¸')">å…‘æ¢</button>
                        </div>
                    </div>
                </div>
                <div class="card act-card">
                    <img src="https://images.unsplash.com/photo-1616401784845-180882ba9ba8?auto=format&fit=crop&w=400" class="act-img">
                    <div class="act-body">
                        <h4>ç«¹åˆ¶ç‰™åˆ·å¥—è£…</h4>
                        <div style="margin-top: auto; padding-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--accent); font-weight: bold;">300 ç§¯åˆ†</span>
                            <button class="btn btn-sm btn-primary" onclick="redeem(300, 'ç«¹ç‰™åˆ·')">å…‘æ¢</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. ä¸ªäººä¸­å¿ƒ -->
        <div id="profile" class="page-section">
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 30px;">
                <!-- å·¦ä¾§ç”¨æˆ·ä¿¡æ¯ -->
                <div class="card" style="text-align: center;">
                    <div id="user-info-box" style="display: none;">
                        <div style="width: 100px; height: 100px; background: var(--primary); border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; color: white; font-size: 2.5rem;">
                            <i class="fas fa-user"></i>
                        </div>
                        <h2 id="u-name">User</h2>
                        <span id="u-role" style="background: #eee; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem;">ä¸ªäººç”¨æˆ·</span>

                        <div style="display: flex; justify-content: space-around; margin-top: 30px;">
                            <div><div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);" id="u-points">0</div><div style="font-size: 0.8rem; color: #888;">ç§¯åˆ†</div></div>
                            <div><div style="font-size: 1.5rem; font-weight: bold; color: var(--secondary);">LV.2</div><div style="font-size: 0.8rem; color: #888;">ç­‰çº§</div></div>
                        </div>

                        <button class="btn btn-outline" style="width: 100%; margin-top: 30px; border-color: #ef4444; color: #ef4444;" onclick="doLogout()">é€€å‡ºç™»å½•</button>
                    </div>

                    <div id="guest-box">
                        <i class="fas fa-lock" style="font-size: 4rem; color: #ccc; margin-bottom: 20px;"></i>
                        <p>ç™»å½•åæŸ¥çœ‹è¯¦ç»†æ•°æ®</p>
                        <button class="btn btn-primary" style="margin-top: 20px;" onclick="openAuth('login')">ç«‹å³ç™»å½•</button>
                    </div>
                </div>

                <!-- å³ä¾§å›¾è¡¨ -->
                <div class="card">
                    <h3>æˆ‘çš„åˆ†ç±»æ•°æ®ç»Ÿè®¡</h3>
                    <div style="height: 300px; position: relative;">
                        <canvas id="statsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- å¼¹çª—ï¼šç™»å½•/æ³¨å†Œ -->
    <div class="modal-overlay" id="authModal">
        <div class="modal-box">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <h2 id="modal-title">ç™»å½•</h2>
                <span onclick="closeModal()" style="cursor: pointer; font-size: 1.5rem;">&times;</span>
            </div>

            <div id="role-switch" style="display: none; margin-bottom: 20px; gap: 10px;">
                <button class="btn btn-outline" style="flex: 1;" onclick="setRole('personal', this)" id="btn-role-p">ä¸ªäºº</button>
                <button class="btn btn-outline" style="flex: 1;" onclick="setRole('store', this)" id="btn-role-s">å•†å®¶</button>
            </div>

            <input type="text" id="inp-user" class="form-input" placeholder="ç”¨æˆ·å">
            <input type="password" id="inp-pass" class="form-input" placeholder="å¯†ç ">

            <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="submitAuth()">æäº¤</button>
            <p style="text-align: center; margin-top: 15px; cursor: pointer; color: var(--primary);" onclick="toggleAuthMode()" id="switch-text">æ²¡æœ‰è´¦å·ï¼Ÿå»æ³¨å†Œ</p>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šå‘å¸ƒæ´»åŠ¨ -->
    <div class="modal-overlay" id="actModal">
        <div class="modal-box">
            <h2>å‘å¸ƒæ–°æ´»åŠ¨</h2>
            <input type="text" id="act-title" class="form-input" placeholder="æ´»åŠ¨æ ‡é¢˜">
            <input type="text" id="act-desc" class="form-input" placeholder="ç®€å•æè¿°">
            <input type="date" id="act-date" class="form-input">
            <input type="text" id="act-loc" class="form-input" placeholder="åœ°ç‚¹">
            <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="submitAct()">å‘å¸ƒ</button>
            <button class="btn btn-outline" style="width: 100%; justify-content: center; margin-top: 10px;" onclick="closeModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // --- å…¨å±€çŠ¶æ€ ---
        let user = JSON.parse(localStorage.getItem('user')) || null;
        let authMode = 'login'; // login or register
        let regRole = 'personal';
        let statsChart = null;

        // --- åˆå§‹åŒ– ---
        window.onload = () => {
            refreshUI();
            fetchActivities();
            fetchLeaderboard();
            initChart();
        };

        function switchPage(pid) {
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            document.getElementById(pid).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            // ç®€å•é«˜äº®é€»è¾‘
            const idx = ['home', 'carbon', 'activity', 'store', 'profile'].indexOf(pid);
            if(idx>-1) document.querySelectorAll('.nav-item')[idx].classList.add('active');

            if(pid === 'profile') updateStats();
        }

        // --- è®¤è¯é€»è¾‘ ---
        function openAuth(mode) {
            authMode = mode;
            document.getElementById('authModal').style.display = 'flex';
            document.getElementById('modal-title').innerText = mode==='login'?'ç”¨æˆ·ç™»å½•':'æ–°ç”¨æˆ·æ³¨å†Œ';
            document.getElementById('switch-text').innerText = mode==='login'?'æ²¡æœ‰è´¦å·ï¼Ÿå»æ³¨å†Œ':'å·²æœ‰è´¦å·ï¼Ÿå»ç™»å½•';
            document.getElementById('role-switch').style.display = mode==='register'?'flex':'none';
            if(mode==='register') setRole('personal', document.getElementById('btn-role-p'));
        }
        function closeModal() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.style.display='none');
        }
        function toggleAuthMode() { openAuth(authMode==='login'?'register':'login'); }

        function setRole(r, btn) {
            regRole = r;
            document.querySelectorAll('#role-switch .btn').forEach(b => {
                b.style.background = 'transparent'; b.style.color = 'var(--primary)';
            });
            btn.style.background = 'var(--primary)'; btn.style.color = 'white';
        }

        async function submitAuth() {
            const u = document.getElementById('inp-user').value;
            const p = document.getElementById('inp-pass').value;
            if(!u || !p) return alert("è¯·è¾“å…¥å®Œæ•´");

            const url = authMode === 'login' ? '/api/login' : '/api/register';
            const body = { username: u, password: p };
            if(authMode === 'register') body.role = regRole;

            try {
                const res = await fetch(url, { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
                const data = await res.json();
                if(data.success) {
                    if(authMode === 'register') {
                        alert("æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•"); toggleAuthMode();
                    } else {
                        user = data.user;
                        localStorage.setItem('user', JSON.stringify(user));
                        closeModal();
                        refreshUI();
                    }
                } else alert(data.message);
            } catch(e) { console.error(e); }
        }

        async function doLogout() {
            await fetch('/api/logout', {method:'POST'});
            localStorage.removeItem('user');
            user = null;
            refreshUI();
        }

        function refreshUI() {
            const isLogin = !!user;
            document.getElementById('desktop-auth').style.display = isLogin ? 'none' : 'block';
            document.getElementById('user-info-box').style.display = isLogin ? 'block' : 'none';
            document.getElementById('guest-box').style.display = isLogin ? 'none' : 'block';

            if(isLogin) {
                document.getElementById('u-name').innerText = user.username;
                document.getElementById('u-role').innerText = user.role==='store'?'è®¤è¯å•†å®¶':'ä¸ªäººç”¨æˆ·';
                document.getElementById('u-points').innerText = user.points;
                document.getElementById('shop-points').innerText = user.points;

                // å•†å®¶ç‰¹æƒ
                document.getElementById('btn-create-act').style.display = user.role==='store'?'block':'none';
            }
        }

        // --- æ ¸å¿ƒï¼šAI è¯†åˆ« ---
        function handleFile(input) {
            if(input.files && input.files[0]) {
                const r = new FileReader();
                r.onload = e => {
                    document.getElementById('preview-img').src = e.target.result;
                    document.getElementById('ai-result').style.display = 'block';
                    document.getElementById('scanBtn').disabled = false;
                };
                r.readAsDataURL(input.files[0]);
            }
        }

        async function doIdentify() {
            if(!user) return openAuth('login');
            const btn = document.getElementById('scanBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è¯†åˆ«ä¸­...';

            const fd = new FormData();
            fd.append('file', document.getElementById('fileInput').files[0]);

            try {
                const res = await fetch('/api/identify', {method:'POST', body:fd});
                const data = await res.json();
                if(data.success) {
                    const d = data.data;
                    document.getElementById('res-group').innerText = d.group_name;
                    document.getElementById('res-name').innerText = d.class_name;
                    document.getElementById('res-points').innerText = d.points;
                    user.points = d.user_points;
                    localStorage.setItem('user', JSON.stringify(user));
                    refreshUI();
                } else alert(data.message);
            } catch(e) { alert("è¯†åˆ«æœåŠ¡å¼‚å¸¸"); }
            btn.innerHTML = 'å¼€å§‹è¯†åˆ«';
        }

        // --- ç¢³è¶³è¿¹ ---
        function calcCarbon() {
            const car = document.getElementById('in-car').value;
            const elec = document.getElementById('in-elec').value;
            const meat = document.getElementById('in-meat').value;

            document.getElementById('lbl-car').innerText = car;
            document.getElementById('lbl-elec').innerText = elec;
            document.getElementById('lbl-meat').innerText = meat;

            const total = (car * 0.2 + elec * 0.5 + meat * 1.5).toFixed(1);
            document.getElementById('total-co2').innerText = total;

            const p = Math.min((total/100)*100, 100);
            const color = total > 50 ? '#ef4444' : '#10b981';
            document.getElementById('carbon-ring').style.background = `conic-gradient(${color} ${p}%, #e5e7eb 0%)`;
        }

        async function submitCarbon() {
            if(!user) return openAuth('login');
            const total = document.getElementById('total-co2').innerText;
            const res = await fetch('/api/carbon', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({
                    car: document.getElementById('in-car').value,
                    elec: document.getElementById('in-elec').value,
                    meat: document.getElementById('in-meat').value,
                    total: total
                })
            });
            const d = await res.json();
            if(d.success) {
                alert("è®°å½•æˆåŠŸï¼Œç§¯åˆ†+5");
                user.points = d.points;
                refreshUI();
            }
        }

        // --- æ´»åŠ¨é€»è¾‘ ---
        async function fetchActivities() {
            const res = await fetch('/api/activities');
            const data = await res.json();
            if(data.success) {
                const grid = document.getElementById('act-grid');
                grid.innerHTML = data.data.map(a => `
                    <div class="card act-card">
                        <img src="${a.image}" class="act-img">
                        <div class="act-body">
                            <h4>${a.title}</h4>
                            <p style="color:#666; font-size:0.9rem; margin-bottom:10px;">${a.description}</p>
                            <div class="act-meta">
                                <span><i class="far fa-calendar"></i> ${a.date}</span>
                                <span><i class="fas fa-map-marker-alt"></i> ${a.location}</span>
                            </div>
                            <div style="margin-top:auto; display:flex; justify-content:space-between; align-items:center;">
                                <span style="font-size:0.8rem; color:var(--primary);">å‘èµ·: ${a.creator}</span>
                                <button class="btn btn-sm btn-outline" onclick="joinAct(${a.id})">æŠ¥å (${a.joined})</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function openActModal() { document.getElementById('actModal').style.display = 'flex'; }

        async function submitAct() {
            const body = {
                title: document.getElementById('act-title').value,
                desc: document.getElementById('act-desc').value,
                date: document.getElementById('act-date').value,
                location: document.getElementById('act-loc').value
            };
            const res = await fetch('/api/activities', {
                method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
            });
            const d = await res.json();
            if(d.success) { alert("å‘å¸ƒæˆåŠŸ"); closeModal(); fetchActivities(); }
            else alert(d.message);
        }

        async function joinAct(id) {
            if(!user) return openAuth('login');
            const res = await fetch('/api/activities/join', {
                method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id})
            });
            const d = await res.json();
            if(d.success) { alert("æŠ¥åæˆåŠŸ +20åˆ†"); user.points = d.points; refreshUI(); fetchActivities(); }
        }

        // --- æ’è¡Œæ¦œ ---
        async function fetchLeaderboard() {
            try {
                const res = await fetch('/api/leaderboard');
                const d = await res.json();
                if(d.success) {
                    const list = document.getElementById('leaderboard-list');
                    list.innerHTML = d.data.map((u, i) => `
                        <div class="leaderboard-item">
                            <div style="display:flex; gap:10px; align-items:center;">
                                <div class="rank-badge rank-${i+1}">${i+1}</div>
                                <span>${u.username}</span>
                            </div>
                            <span style="font-weight:bold; color:var(--primary);">${u.points}</span>
                        </div>
                    `).join('');
                }
            } catch(e){}
        }

        // --- å…‘æ¢ ---
        async function redeem(cost, item) {
            if(!user) return openAuth('login');
            const res = await fetch('/api/redeem', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({cost, item})
            });
            const d = await res.json();
            if(d.success) { alert("å…‘æ¢æˆåŠŸ"); user.points = d.points; refreshUI(); }
            else alert(d.message);
        }

        // --- å›¾è¡¨ ---
        function initChart() {
            const ctx = document.getElementById('statsChart').getContext('2d');
            statsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['å¯å›æ”¶', 'æœ‰å®³', 'å¨ä½™', 'å…¶ä»–'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#34d399', '#ef4444', '#f59e0b', '#9ca3af']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        async function updateStats() {
            if(!user) return;
            const res = await fetch('/api/stats');
            const d = await res.json();
            if(d.success) {
                statsChart.data.datasets[0].data = d.pie;
                statsChart.update();
            }
        }
    </script>
</body>
</html>